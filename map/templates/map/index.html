{% extends "base_map.html" %}

{% block map_content %}

	{% load cache %}
	{% cache 120 map %}

		var states = [], cities = [], counties = [], featureGroups = {};

    var data = [{{ states | safe }}, {{ counties | safe }}, {{ cities | safe }}]
    
		for (var i=0; i < data.length; i++) {
			$.each(data[i].features, function(feature) {
      
	      var color;
	            
	      if(this.properties.limited_ice_cooperation == "yes-by-law") {
	        color = "#bf2";
	      } else if(this.properties.limited_ice_cooperation == "yes-in-practice") {
	        color = "#ff8";
	      } else if(this.properties.limited_ice_cooperation == "unlimited") {
	        color = "#f22";
	      } else {
	        color = "#bf2";
	      }
	      
	      var feature = L.geoJson(this.geometry,
	        {
						"color": color,
						"weight": 2,
						"fillOpacity": "0.5"
					});
	                
        feature.properties = this.properties
        feature.bindTooltip('<h4>' + this.properties.name + '</h4>')
				
        states.push(feature);
			});
		}

    sanctuary.data = {
      states: L.featureGroup(states),
      cities: L.featureGroup(cities),
      counties: L.featureGroup(counties)
    }
    
    $.each(sanctuary.data, function(index) {
      
      sanctuary.data[index].eachLayer(function(layer) {
        layer.on("click touchstart", function(e) {
					var bounds = layer.getBounds();
			    sanctuary.getMap().flyToBounds(bounds, 12, {duration:1});
					sanctuary.getLocationsWithinBounds(bounds);
        });
      })
      
      sanctuary.data[index].on("mouseover", function(e) {
        e.layer.options.oldColor = e.layer.options.color;
        e.layer.setStyle({"color":"#78a515"});
      });
      
      sanctuary.data[index].on("mouseout", function(e) {
        e.layer.setStyle({"color":e.layer.options.oldColor});
      });
      
      sanctuary.addFeature(sanctuary.data[index]);
    })

	{% endcache %}

{% endblock %}
